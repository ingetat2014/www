{% extends "FOSUserBundle::layout.html.twig" %}
{% block title %}Feuille de route|New{% endblock %}
{% block fos_user_content %}
{% block body -%}
<div class="page-header">  <h2> Une nouvelle feuille de route</h2> </div>  

{{ form_start(form) }}
<div class="row">
    <span class="alert-danger ">{{ form_errors(form) }}</span>
</div>
<div class="row">
    <div class="span7">
        <div class="row">
            <div class="span4">
                <fieldset>
                    <legend>Début de mission  </legend>
                    <div class="row-fluid">
                        <div class="span5">{{ form_label(form.fdrInstance," En Instance") }}</div>
                        <span class="">{{ form_widget(form.fdrInstance) }}</span><span class="alert-danger ">{{ form_errors(form.fdrInstance) }}</span>
                    </div>
                    <div class="row-fluid">
                        <div class="span1">{{ form_label(form.dateDebutMission," ") }}</div>
{{ form_widget(form.dateDebutMission) }}<span class="alert-danger ">{{ form_errors(form.dateDebutMission) }}</span>
                    </div>
                    <div class="row-fluid {{role.crFDRAutrAgence?'':'cacher'}}">
                        <div class="span1">{{ form_label(form.filiale," ") }}</div>
{{ form_widget(form.filiale) }}<span class="alert-danger ">{{ form_errors(form.filiale) }}</span>
                    </div>


                    <div class="row-fluid {{role.crFDRAutrAgence?'':'cacher'}}">
                        <div class="span1">{{ form_label(form.depot," ") }}</div>
                        {{ form_widget(form.depot) }}
                        <span class="alert-danger ">{{ form_errors(form.depot) }}</span>
                    </div>

                    <div class="row-fluid">
                        <div class="span1">{{ form_label(form.vehicule," ") }}</div>
                        <span class="">{{ form_widget(form.vehicule) }}</span><span class="alert-danger ">{{ form_errors(form.vehicule) }}</span>
                    </div>
                    <div class="row-fluid">
                        <div class="span1">{{ form_label(form.compteurReel," ") }}</div>
{{ form_widget(form.compteurReel) }}<span class="alert-danger ">{{ form_errors(form.compteurReel) }}</span>
                    </div>

                </fieldset>
            </div>

            <div class="span3">
                <fieldset> 
                    <legend>Prestation/Clients/Secteurs  </legend>

                    <div class="row-fluid">
                        <div class="span1">{{ form_label(form.typePrestation," ") }}</div>
                        <div class="span11"><label>Prestation : </label></div>
{{ form_widget(form.typePrestation) }}<span class="alert-danger ">{{ form_errors(form.typePrestation) }}</span>
                    </div>

                    <div class="row-fluid">
                        <div class="span1">{{ form_label(form.secteurs," ") }}</div>
                        <div class="span11"><label>Secteurs : </label></div>
{{ form_widget(form.secteurs) }}<span class="alert-danger ">{{ form_errors(form.secteurs) }}</span>
                    </div>

                    <div class="row-fluid">
                        <div class="span12">{{ form_label(form.clients," ") }}</div>
                        <div class="span12"><label>Clients : </label></div>
{{ form_widget(form.clients) }}<span class="alert-danger ">{{ form_errors(form.clients) }}</span>
                    </div>

                </fieldset>
            </div>
        </div>
        <div class="row">
            <div class="span6">
                <fieldset>
                    <legend> Manutentions Externes </legend>
                    <div class="span3">
                        <fieldset>
                            <legend class="subfieldset" style="text-align: center"> 1 </legend>
                            <div class="row-fluid">
                                <span class="span1">{{ form_label(form.nomManExterne1," ") }}</span>
{{ form_widget(form.nomManExterne1) }}<span class="alert-danger ">{{ form_errors(form.nomManExterne1) }}</span>
                            </div>
                            <div class="row-fluid">
                                <span class="span1">{{ form_label(form.cinManExterne1," ") }}</span>
{{ form_widget(form.cinManExterne1) }}<span class="alert-danger ">{{ form_errors(form.cinManExterne1) }}</span>
                            </div>
                        </fieldset>
                    </div>
                    <div class="span3">
                        <fieldset>
                            <legend class="subfieldset" style="text-align: center"> 2 </legend>
                            <div class="row-fluid">
                                <span class="span1">{{ form_label(form.nomManExterne2," ") }}</span>
{{ form_widget(form.nomManExterne2) }}<span class="alert-danger ">{{ form_errors(form.nomManExterne2) }}</span>
                            </div>
                            <div class="row-fluid">
                                <span class="span1">{{ form_label(form.cinManExterne2," ") }}</span>
{{ form_widget(form.cinManExterne2) }}<span class="alert-danger ">{{ form_errors(form.cinManExterne2) }}</span>
                            </div>
                        </fieldset>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
    <div class="span4">
        <fieldset>
            <legend> Manutention/Chauffeur </legend>
            <div class="row-fluid">
                <div class="span1">{{ form_label(form.nombreManutention," ") }}</div>
{{ form_widget(form.nombreManutention) }}<span class="alert-danger ">{{ form_errors(form.nombreManutention) }}</span>
            </div>
            <div class="row-fluid">
                <div class="span1">{{ form_label(form.manutentions," ") }}</div>
                <div class="span5">{{ form_widget(form.manutentions) }}<span class="alert-danger ">{{ form_errors(form.manutentions) }}</span></div>
            </div>
        </fieldset>
    </div>
</div>

<div class="row-fluid">
    <div class="span5 offset5">{{ form_widget(form.submit) }}</div>
</div>
</div>

<div class="cacher">{{ form_rest(form) }}</div>
    {{ form_end(form) }}

<script>
    $('#fdr_adminbundle_feuillederoute_secteurs, label[for="fdr_adminbundle_feuillederoute_secteurs"]').hide();
    $('#fdr_adminbundle_feuillederoute_clients').hide();

    jQuery(document).ready(function() {
        $("select[id$='_manutentionnaire'],select[id$='_chauffeur'],input[id$='_nombreManutentions'],input[id$='_ayantManutentions']").hide();
        var $container = $('div#fdr_adminbundle_feuillederoute_manutentions');
        var $addLink = $('<br/><a href="#" id="add_manutention" class="btn btn-default">Ajouter Chauff/Manu.</a>');
        $container.append($addLink);
        $container.data('index', $container.children('div').length);
        boucler('chauffeur');
        boucler('manutentionnaire');

        $addLink.click(function(e) {
            var global = parseInt("0" + $("#fdr_adminbundle_feuillederoute_nombreManutention").val());
            $("#fdr_adminbundle_feuillederoute_nombreManutention").val(global);
            var tot = 0;
            for (i = 0; i < $("*[id$='_nombreManutentions']").length; i++)
            {
                var elt = parseInt("0" + $("*[id$='_nombreManutentions']").get(i).value);
                $("*[id$='_nombreManutentions']").get(i).value = elt;
                tot += elt;
            }
            if (tot <= global) {
                addManutention($container);
                $container.data('index', $container.data('index') + 1);
                if ($container.children('div').length >= 3)
                {
                    $('#add_manutention').hide(200);
                    $('#add_manutention').disabled = true;
                }
            }
            else {
                alert('Le total des manutentions (' + tot + ') est > au nombre total (' + global + '),on va reinitialiser ces champs');
                $("*[id$='_nombreManutentions']").val(0);
                $("*[id$='_nombreManutentions']").css('border-color', 'red');
                $("#fdr_adminbundle_feuillederoute_nombreManutention").css('border-color', 'red');
            }
            e.preventDefault();
            return false;
        });
        if ($container.data('index') === 0) {
            addManutention($container);
            $container.data('index', $container.data('index') + 1);
        }
        else {
            $container.children('div').each(function() {
                addDeleteLink($(this));

            });
        }
        function addManutention($container) {

            var $prototype = $($container.attr('data-prototype').replace(/__name__label__/g, 'Manutention N°' + ($container.data('index') + 1))
                    .replace(/__name__/g, ($container.data('index'))));
            addDeleteLink($prototype);
            $container.append($prototype);
            visibilte($container.data('index'), false);

        }

        function addDeleteLink($prototype) {
            $deleteLink = $('<a href="#" class="btn btn-danger btn-sm">Supprimer</a>');
            $prototype.append($deleteLink);
            $deleteLink.click(function(e) {
                if ($container.children('div').length <= 5 && $container.children('div').length > 1)
                {
                    $prototype.remove();
                    $('#add_manutention').show(200);
                    $('#add_manutention').disabled = false;
                }
                e.preventDefault();
                return false;
            });
        }
    });

    function boucler(qui) {
        for (i = 0; i < $("select[id$='_" + qui + "']").length; i++)
        {
            if ($("select[id$='_" + qui + "'] option:selected").get(i).value)
            {
                selectionnerManOuChauff($("select[id$='_" + qui + "'] option:selected").get(i).parentNode.getAttribute('id'), qui);
            }
        }

    }

    function selectionnerManOuChauff(id, qui) {
        var res = id.split("_");
        var manlst = "#fdr_adminbundle_feuillederoute_manutentions_" + res[res.length - 2] + "_manutentionnaire";
        var chaufflst = "#fdr_adminbundle_feuillederoute_manutentions_" + res[res.length - 2] + "_chauffeur";
        var manOuChauff = "#fdr_adminbundle_feuillederoute_manutentions_" + res[res.length - 2] + "_manOuChauff option[value='" + qui + "']";
        var nbreManu = "#fdr_adminbundle_feuillederoute_manutentions_" + res[res.length - 2] + "_nombreManutentions";
        var ayantMan = "#fdr_adminbundle_feuillederoute_manutentions_" + res[res.length - 2] + "_ayantManutentions";
        $(manOuChauff).prop('selected', true);
        if (qui === 'chauffeur')
        {
            $(manlst).hide();
            $(chaufflst).show();
        }
        else if (qui === 'manutentionnaire')
        {
            $(chaufflst).hide();
            $(manlst).show();

        }
        else
        {
            $(chaufflst).hide();
            $(manlst).hide();
        }
        $(ayantMan).attr('checked', true);
    }

    function visibilte(id, etat) {
        var manlst = "#fdr_adminbundle_feuillederoute_manutentions_" + id + "_manutentionnaire";
        var chaufflst = "#fdr_adminbundle_feuillederoute_manutentions_" + id + "_chauffeur";
        var nbreManu = "#fdr_adminbundle_feuillederoute_manutentions_" + id + "_nombreManutentions";
        if (etat === false)
        {
            $(manlst).hide();
            $(chaufflst).hide();
            $(nbreManu).hide();
        }
        else
        {
            $(manlst).show();
            $(chaufflst).show();
            $(nbreManu).show();
        }
    }

    function verifMan() {
        
        /*for (j = 0; j < $("*[id$='_manOuChauff']").length; j++)
         {
         if($("*[id$='_manOuChauff']").get(j).value!==null && $("*[id$='_manOuChauff']").get(j).value!=="")
         {
         if($("*[id$='_manOuChauff']").get(j).value==="chauffeur"){selChauff = true;return true;}
         else {continue;}
         }
         }*/
        // return selChauff;//au moins un chauffeur doit être selectionne
        for (i = 0; i < $("*[id$='_chauffeur']").length; i++)
        {
            for (j = i + 1; j < $("*[id$='_chauffeur']").length; j++)
            {
                if ($("*[id$='_chauffeur']").get(i).value === $("*[id$='_chauffeur']").get(j).value
                        && $("*[id$='_chauffeur']").get(i).value !== ""
                        && $("*[id$='_manOuChauff']").get(i).value === $("*[id$='_manOuChauff']").get(j).value)
                {
                    alert("Un seul/unique chauffeur pour chaque choix");
                    return false;
                }
            }
        }
        for (i = 0; i < $("*[id$='_manutentionnaire']").length; i++)
        {
            for (j = i + 1; j < $("*[id$='_manutentionnaire']").length; j++)
            {
                if ($("*[id$='_manutentionnaire']").get(i).value === $("*[id$='_manutentionnaire']").get(j).value
                        && $("*[id$='_manutentionnaire']").get(i).value !== ""
                        && $("*[id$='_manOuChauff']").get(i).value === $("*[id$='_manOuChauff']").get(j).value)
                {
                    alert("Un seul/unique manutentionnaire pour chaque choix");
                    return false;
                }
            }
        }
        if (true)
        {
            var global = parseInt("0" + $("#fdr_adminbundle_feuillederoute_nombreManutention").val());
            $("#fdr_adminbundle_feuillederoute_nombreManutention").val(global);
            var tot = 0;
            for (i = 0; i < $("*[id$='_nombreManutentions']").length; i++)
            {
                var elt = parseInt("0" + $("*[id$='_nombreManutentions']").get(i).value);
                $("*[id$='_nombreManutentions']").get(i).value = elt;
                tot += elt;
            }
            if (tot > global) {
                alert("La répartition des manutentions n'est pas correcte(Le total des manutentions doit être <= au nombre voulu des manu.,on va reinitialiser ces champs )");
                $("*[id$='_nombreManutentions']").val(0);
                $("*[id$='_nombreManutentions']").css('border-color', 'red');
                $("#fdr_adminbundle_feuillederoute_nombreManutention").css('border-color', 'red');
                return false;
            }
            else
            {
                $("*[id$='_nombreManutentions']").css('border-color', '#515151');
                if (tot === global) {
                    $("*[id='fdr_adminbundle_feuillederoute_nomManExterne1']").val("");
                    $("*[id='fdr_adminbundle_feuillederoute_nomManExterne2']").val("");
                    $("*[id='fdr_adminbundle_feuillederoute_cinManExterne1']").val("");
                    $("*[id='fdr_adminbundle_feuillederoute_cinManExterne2']").val("");
                }
                if ($("*[id$='_nombreManutentions']").css('border-color') === 'rgb(255,0,0)')
                {
                    $("*[id$='_nombreManutentions']").css('border-color', 'green');
                    $("#fdr_adminbundle_feuillederoute_nombreManutention").css('border-color', 'green');
                }
                if($("*[id$='_manOuChauff'] option:selected[value='chauffeur']").length===0 && $("*[id$='_manOuChauff'] option:selected[value='']").length===0)
                {
                    alert("Un chauffeur au minimum doit etre selectionne");
                    return false;
                }
                return true;
            }

        }
    }

</script>

{% endblock %}
{% endblock fos_user_content %}